<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link id="theme-link" rel="stylesheet" href="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="dashboard-page-body">

    <div class="dashboard-body">

        <div class="top-bar">
            <div class="top-bar-left">
                <div class="hamburger-menu" id="hamburgerMenu">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <header class="header" id="topBarProfile">
                    <label for="profileUpload" class="profile-icon" title="Clique para alterar a foto">
                        <img id="topBarImage" src="{{ foto_perfil_url or url_for('static', filename='images/default-avatar.svg') }}" alt="Foto do Perfil">
                    </label>
                    <h2 class="user-name">{{ nome_completo or 'Nome do Usuário' }}</h2>
                </header>
            </div>
            <a href="{{ url_for('logout') }}" class="logout-button">Sair</a>
        </div>

        <nav class="dropdown-menu" id="dropdownMenu">
            <input type="file" id="profileUpload" accept="image/jpeg, image/jpg, image/png" style="display: none;">

            <div class="menu-section top">
                <a href="#" class="profile-icon-menu" onclick="document.getElementById('profileUpload').click(); return false;" title="Alterar foto de perfil">
                    <img id="menuImage" src="{{ foto_perfil_url or url_for('static', filename='images/default-avatar.svg') }}" alt="Foto de Perfil">
                </a>
            </div>

            <div class="menu-section middle">
                <a href="{{ url_for('painel') }}" class="menu-link {{ 'active' if view == 'home' else '' }}" title="Início">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                </a>
                <a href="{{ url_for('banco_questoes') }}" class="menu-link {{ 'active' if view == 'banco_questoes' else '' }}" title="Banco de Questões">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </a>
                <a href="{{ url_for('cadastrar_questoes') }}" class="menu-link {{ 'active' if view == 'cadastrar_questoes' else '' }}" title="Cadastrar Questão">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </a>
                <a href="{{ url_for('lixeira') }}" class="menu-link {{ 'active' if view == 'lixeira' else '' }}" title="Lixeira">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </a>
            </div>

            <div class="menu-section bottom">
                <a href="{{ url_for('configuracoes') }}" class="menu-link {{ 'active' if view == 'configuracoes' else '' }}" title="Configurações">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.25C8.61,5.5,8.08,5.82,7.58,6.2L5.19,5.24C4.97,5.16,4.72,5.23,4.6,5.45L2.68,8.77 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.36,4.76,11.68,4.76,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.44 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48,0.41l0.36-2.44c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </a>
                <a href="{{ url_for('logout') }}" class="menu-link" title="Sair">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </a>
            </div>
        </nav>

        {% if view == 'home' %}
            <div class="search-area">
                <main class="search-wrapper" id="searchWrapper">
                    <div id="searchTermBubble" class="search-term-bubble" style="display: none;"></div>
                    <input type="search" id="searchInput" class="search-input" placeholder="Buscar por título, nível ou grau de ensino...">
                    <button type="button" id="searchBtn" class="search-bubble" title="Buscar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                </main>
                <div class="search-results-container" id="searchResultsContainer" style="display: none;">
                    <div class="question-list" id="searchResultsList"></div>
                </div>
            </div>
        {% elif view == 'banco_questoes' %}
            <div class="content-panel">
                <h2>Banco de Questões</h2>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="selection-actions" id="selectionActions">
                    <span id="selectionCount">0 questões selecionadas</span>
                    <div class="action-buttons">
                        <select id="exportFormat">
                            <option value="txt">Exportar como TXT</option>
                            <option value="json">Exportar como JSON</option>
                            <option value="pdf">Exportar como PDF</option>
                            <option value="docx">Exportar como DOCX</option>
                        </select>
                        <button id="exportBtn" class="primary-btn">Exportar</button>
                    </div>
                </div>

                <div class="panel-header">
                    {% if search_query %}
                        <h3>Resultados da busca por "{{ search_query }}"</h3>
                    {% else %}
                        <h3>Questões Cadastradas</h3>
                    {% endif %}
                    <a href="{{ url_for('lixeira') }}" class="trash-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        <span>Ver Lixeira</span>
                    </a>
                </div>
                <div class="question-list">
                    {% for questao in questoes %}
                        <div class="question-item" data-id="{{ questao.id }}" id="questao-{{ questao.id }}">
                            <div class="selection-checkbox">
                                <input type="checkbox" class="question-checkbox" data-id="{{ questao.id }}">
                            </div>
                            <div class="question-item-content">
                                <p><strong>#{{ questao.id }}:</strong> {{ questao.enunciado }}</p>
                                <div class="question-tags">
                                    <span class="tag tag-{{ questao.nivel_dificuldade|lower }}">{{ questao.nivel_dificuldade.replace('_', ' ') }}</span>
                                    {% if questao.grau_ensino %}
                                    <span class="tag tag-grau">{{ questao.grau_ensino }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <button class="delete-btn" data-id="{{ questao.id }}" title="Mover para a Lixeira">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    {% else %}
                        <p>Nenhuma questão cadastrada ainda.</p>
                    {% endfor %}
                </div>
            </div>
        {% elif view == 'cadastrar_questoes' %}
            <div class="content-panel">
                <h2>Cadastrar Nova Questão</h2>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <form class="question-form" action="{{ url_for('add_questao') }}" method="POST">
                    <div class="form-group">
                        <label for="tipo_questao">Tipo de Questão</label>
                        <select name="tipo_questao" id="tipo_questao" required>
                            <option value="ESCOLHA_UNICA">Escolha Única (Apenas 1 correta)</option>
                            <option value="MULTIPLA_ESCOLHA">Múltipla Escolha (Várias corretas)</option>
                            <option value="DISCURSIVA">Discursiva (Texto livre)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="enunciado">Enunciado da Questão</label>
                        <textarea name="enunciado" id="enunciado" rows="4" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nivel_dificuldade">Nível de Dificuldade</label>
                            <select name="nivel_dificuldade" id="nivel_dificuldade" required>
                                <option value="FACIL">Fácil</option>
                                <option value="MEDIO">Médio</option>
                                <option value="DIFICIL">Difícil</option>
                                <option value="MUITO_DIFICIL">Muito Difícil</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="grau_ensino">Grau de Ensino</label>
                            <select name="grau_ensino" id="grau_ensino">
                                <option value="">Selecione o Grau</option>
                                <option value="Ensino Fundamental I">Ensino Fundamental I</option>
                                <option value="Ensino Fundamental II">Ensino Fundamental II</option>
                                <option value="Ensino Médio">Ensino Médio</option>
                                <option value="Ensino Superior">Ensino Superior</option>
                            </select>
                        </div>
                    </div>

                    <div id="optionsContainer"></div>

                    <div class="form-group" id="addOptionWrapper">
                        <button type="button" id="addOptionBtn" class="secondary-btn">Adicionar Opção</button>
                    </div>

                    <button type="submit" class="submit-btn">Cadastrar Questão</button>
                </form>
            </div>
        {% elif view == 'lixeira' %}
            <div class="content-panel">
                <div class="panel-header">
                    <h2>Lixeira</h2>
                    <a href="{{ url_for('banco_questoes') }}" class="back-link">&larr; Voltar para Questões</a>
                </div>
                <div class="question-list">
                    {% for questao in questoes %}
                        <div class="question-item deleted-item">
                            <div class="question-item-content">
                                <p><strong>#{{ questao.id }}:</strong> {{ questao.enunciado }}</p>
                                <small>Tipo: {{ questao.tipo_questao.replace('_', ' ') }}</small>
                            </div>
                            <div class="action-buttons">
                                <button class="restore-btn" data-id="{{ questao.id }}" title="Restaurar Questão">Restaurar</button>
                                <button class="perm-delete-btn" data-id="{{ questao.id }}" title="Excluir Permanentemente">
                                    <i class="fas fa-trash-alt"></i> Excluir
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <p>A lixeira está vazia.</p>
                    {% endfor %}
                </div>
            </div>
        {% elif view == 'configuracoes' %}
            <div class="content-panel">
                <h2>Configurações</h2>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="settings-container">
                    <div class="settings-card">
                        <h3>Informações do Perfil</h3>
                        <form action="{{ url_for('update_profile') }}" method="POST">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nome">Nome</label>
                                    <input type="text" id="nome" name="nome" value="{{ user.nome }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="sobrenome">Sobrenome</label>
                                    <input type="text" id="sobrenome" name="sobrenome" value="{{ user.sobrenome }}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" value="{{ user.email }}" disabled>
                                <small>O email não pode ser alterado.</small>
                            </div>
                            <button type="submit" class="submit-btn">Salvar Alterações</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3>Alterar Senha</h3>
                        <form action="{{ url_for('change_password') }}" method="POST">
                            <div class="form-group">
                                <label for="senha_atual">Senha Atual</label>
                                <input type="password" id="senha_atual" name="senha_atual" required>
                            </div>
                            <div class="form-group">
                                <label for="nova_senha">Nova Senha</label>
                                <input type="password" id="nova_senha" name="nova_senha" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmar_senha">Confirmar Nova Senha</label>
                                <input type="password" id="confirmar_senha" name="confirmar_senha" required>
                            </div>
                            <button type="submit" class="submit-btn">Alterar Senha</button>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="modal-overlay" id="questionModalOverlay">
            <div class="modal-content">
                <button class="modal-close-btn" id="modalCloseBtn">&times;</button>
                <div id="modalViewContent">
                    <h3 id="modalQuestionTitle"></h3>
                    <div class="question-tags" id="modalTags"></div>
                    <ul class="modal-options-list" id="modalOptionsList"></ul>
                </div>
                <div id="modalEditContent" style="display: none;"></div>

                <div class="modal-footer">
                    <div id="defaultFooterButtons">
                        <button class="edit-btn" id="modalEditBtn">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="delete-btn modal-delete-btn" id="modalDeleteBtn">
                            <i class="fas fa-trash-alt"></i> Excluir
                        </button>
                    </div>
                    <div id="searchFooterButtons" style="display: none;">
                        <button class="secondary-btn" id="modalCancelBtn">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="primary-btn" id="modalGoToQuestionBtn">
                            <i class="fas fa-arrow-right"></i> Ir para Questão
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="theme-toggler">
        <button id="theme-toggle-btn"></button>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
</body>
</html>